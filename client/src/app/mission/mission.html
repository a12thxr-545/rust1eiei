<div class="missions-page">
    <!-- Header -->
    <div class="page-header">
        <h1>Missions</h1>
        <p>Explore and manage your space missions</p>
    </div>

    <!-- Tabs -->
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab" [class.active]="selectedTabIndex === 0" (click)="onTabChange(0)">
                <span>Explore</span>
                @if (missions().length > 0) {
                <span class="badge">{{ missions().length }}</span>
                }
            </button>
            <button class="tab" [class.active]="selectedTabIndex === 1" (click)="onTabChange(1)">
                <span>Participating</span>
                @if (joinedMissions().length > 0) {
                <span class="badge joined">{{ joinedMissions().length }}</span>
                }
            </button>
            <button class="tab" [class.active]="selectedTabIndex === 2" (click)="onTabChange(2)">
                <span>My Missions</span>
                @if (myMissions().length > 0) {
                <span class="badge my">{{ myMissions().length }}</span>
                }
            </button>
            <button class="tab" [class.active]="selectedTabIndex === 3" (click)="onTabChange(3)">
                <span>Inbox</span>
                @if (socialService.pendingRequests().length + socialService.invitations().length > 0) {
                <span class="badge inbox">{{ socialService.pendingRequests().length + socialService.invitations().length
                    }}</span>
                }
            </button>
            <button class="tab" [class.active]="selectedTabIndex === 4" (click)="onTabChange(4)">
                <span>History</span>
                @if (finishedMissions().length > 0) {
                <span class="badge history">{{ finishedMissions().length }}</span>
                }
            </button>
        </div>

        <!-- Current Mission Alert -->
        @if (currentMissionId() !== null) {
        <div class="current-mission-alert">
            <span>You are currently in a mission. Leave it to join another.</span>
        </div>
        }

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Other Missions -->
            @if (selectedTabIndex === 0) {
            <div class="search-container">
                <div class="search-box">
                    <input type="text" [(ngModel)]="searchCode" (ngModelChange)="loadOtherMissions()"
                        placeholder="Search by Room ID (e.g. AB123)..." maxlength="5">
                </div>
            </div>
            @if (isLoading()) {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading missions...</p>
            </div>
            } @else if (missions().length === 0) {
            <div class="empty-state">
                <h3>No missions from others yet</h3>
                <p>Wait for other users to create missions!</p>
            </div>
            } @else {
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Room ID</th>
                            <th>Mission</th>
                            <th>Status</th>
                            <th>Crew</th>
                            <th>Created</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (mission of missions(); track mission.id) {
                        <tr [class.in-mission]="isInMission(mission.id)">
                            <td class="code-cell">
                                <span class="room-code">#{{ mission.code }}</span>
                            </td>
                            <td>
                                <div class="mission-cell">
                                    @if (mission.image_url) {
                                    <div class="mission-icon has-image">
                                        <img [src]="mission.image_url" alt="Mission" />
                                    </div>
                                    }
                                    <div class="mission-info">
                                        <span class="name">{{ mission.name }}</span>
                                        <span class="desc">{{ mission.description || 'No description' }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="status" [class]="getStatusClass(mission.status)">
                                    {{ mission.status }}
                                </span>
                            </td>
                            <td>
                                <span class="crew">
                                    Crew: {{ mission.crew_count }}
                                </span>
                            </td>
                            <td class="date">{{ mission.created_at | date:'mediumDate' }}</td>
                            <td>
                                <div class="actions">
                                    <button class="action-btn" title="View" (click)="openViewModal(mission)">
                                        View
                                    </button>
                                    @if (isInMission(mission.id)) {
                                    <button class="action-btn leave" title="Leave" (click)="leaveMission(mission)"
                                        [disabled]="isProcessing()">
                                        Leave
                                    </button>
                                    } @else {
                                    <button class="action-btn join" title="Join" (click)="joinMission(mission)"
                                        [disabled]="isProcessing() || currentMissionId() !== null">
                                        Join
                                    </button>
                                    }
                                </div>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
            }
            }

            <!-- Participating Missions -->
            @if (selectedTabIndex === 1) {
            @if (isLoadingMyMissions()) {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading participating missions...</p>
            </div>
            } @else if (joinedMissions().length === 0) {
            <div class="empty-state">
                <h3>You haven't joined any missions yet</h3>
                <p>Explore the mission list to find a squad to join!</p>
            </div>
            } @else {
            <div class="table-wrapper">
                <table class="joined-table">
                    <thead>
                        <tr>
                            <th>Room ID</th>
                            <th>Mission</th>
                            <th>Status</th>
                            <th>Crew</th>
                            <th>Leader</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (mission of joinedMissions(); track mission.id) {
                        <tr [class.in-mission]="isInMission(mission.id)">
                            <td class="code-cell">
                                <span class="room-code">#{{ mission.code }}</span>
                            </td>
                            <td>
                                <div class="mission-cell">
                                    @if (mission.image_url) {
                                    <div class="mission-icon has-image">
                                        <img [src]="mission.image_url" alt="Mission" />
                                    </div>
                                    }
                                    <div class="mission-info">
                                        <span class="name">{{ mission.name }}</span>
                                        <span class="desc">{{ mission.description || 'No description' }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="status" [class]="getStatusClass(mission.status)">
                                    {{ mission.status }}
                                </span>
                            </td>
                            <td>
                                <span class="crew">
                                    Crew: {{ mission.crew_count }}
                                </span>
                            </td>
                            <td class="leader-cell">
                                <span class="leader-name">{{ mission.chief_name }}</span>
                            </td>
                            <td>
                                <div class="actions">
                                    <button class="action-btn" title="View" (click)="openViewModal(mission)">
                                        View
                                    </button>
                                    <button class="action-btn leave" title="Leave" (click)="leaveMission(mission)"
                                        [disabled]="isProcessing()">
                                        Leave
                                    </button>
                                </div>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
            }
            }

            <!-- My Missions -->
            @if (selectedTabIndex === 2) {
            @if (isLoadingMyMissions()) {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading your missions...</p>
            </div>
            } @else if (myMissions().length === 0) {
            <div class="empty-state">
                <h3>You haven't created any missions yet</h3>
                <p>Click "Create Mission" in the navbar to get started!</p>
            </div>
            } @else {
            <div class="table-wrapper">
                <table class="my-table">
                    <thead>
                        <tr>
                            <th>Room ID</th>
                            <th>Mission</th>
                            <th>Status</th>
                            <th>Crew</th>
                            <th>Created</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (mission of myMissions(); track mission.id) {
                        <tr>
                            <td class="code-cell">
                                <span class="room-code">#{{ mission.code }}</span>
                            </td>
                            <td>
                                <div class="mission-cell">
                                    @if (mission.image_url) {
                                    <div class="mission-icon has-image">
                                        <img [src]="mission.image_url" alt="Mission" />
                                    </div>
                                    }
                                    <div class="mission-info">
                                        <span class="name">{{ mission.name }}</span>
                                        <span class="desc">{{ mission.description || 'No description' }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="status" [class]="getStatusClass(mission.status)">
                                    {{ mission.status }}
                                </span>
                            </td>
                            <td>
                                <span class="crew">
                                    Crew: {{ mission.crew_count }}
                                </span>
                            </td>
                            <td class="date">{{ mission.created_at | date:'mediumDate' }}</td>
                            <td>
                                <div class="actions">
                                    <button class="action-btn" title="View" (click)="openViewModal(mission)">
                                        View
                                    </button>
                                    <button class="action-btn edit" title="Edit" (click)="openEditModal(mission)">
                                        Edit
                                    </button>
                                    <button class="action-btn delete" title="Delete" (click)="openDeleteModal(mission)">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
            }
            }

            <!-- Inbox -->
            @if (selectedTabIndex === 3) {
            <div class="inbox-container">
                <!-- Friends Section -->
                <div class="inbox-section friends-list-section">
                    <h3>My Brawlers Friends ({{ socialService.friends().length }})</h3>
                    @if (socialService.friends().length > 0) {
                    <div class="request-list">
                        @for (friend of socialService.friends(); track friend.friendship_id) {
                        <div class="request-item">
                            <div class="user-info">
                                <img [src]="friend.avatar_url || '/assets/defaultavtar.jpg'" class="req-avatar">
                                <div class="name-col">
                                    <a [routerLink]="['/u', friend.username]" class="req-name-link">
                                        <span class="req-name">{{ friend.display_name }}</span>
                                    </a>
                                    <span class="req-username">@{{ friend.username }}</span>
                                </div>
                            </div>
                            <div class="req-actions">
                                <span class="friend-badge">✓ Friend</span>
                            </div>
                        </div>
                        }
                    </div>
                    } @else {
                    <div class="empty-inbox">
                        <p>No friends yet. Search for brawlers below to grow your squad!</p>
                    </div>
                    }
                </div>

                <!-- Search Brawlers Section -->
                <div class="inbox-section search-brawlers">
                    <h3>Search Brawlers</h3>
                    <div class="search-box">
                        <input type="text" [(ngModel)]="brawlerSearchQuery" (ngModelChange)="onBrawlerSearch()"
                            placeholder="Find fighters to connect with...">
                    </div>

                    @if (brawlerSearchResults().items.length > 0) {
                    <div class="request-list search-results">
                        @for (user of brawlerSearchResults().items; track user.id) {
                        @if (user.id !== passportService.data()?.id) {
                        <div class="request-item">
                            <div class="user-info">
                                <img [src]="user.avatar_url || '/assets/defaultavtar.jpg'" class="req-avatar">
                                <div class="name-col">
                                    <a [routerLink]="['/u', user.username]" class="req-name-link">
                                        <span class="req-name">{{ user.display_name }}</span>
                                    </a>
                                    <span class="req-username">@{{ user.username }}</span>
                                </div>
                            </div>
                            <div class="req-actions">
                                @if (isFriend(user.id)) {
                                <span class="friend-badge">✓ Friend</span>
                                } @else {
                                <button class="action-btn join" (click)="addFriend(user.id)">Add Friend</button>
                                }
                            </div>
                        </div>
                        }
                        }
                    </div>
                    }
                </div>

                <div class="inbox-section">
                    <h3>Friend Requests ({{ socialService.pendingRequests().length }})</h3>
                    <div class="request-list">
                        @for (req of socialService.pendingRequests(); track req.friendship_id) {
                        <div class="request-item">
                            <div class="user-info">
                                <img [src]="req.avatar_url || '/assets/defaultavtar.jpg'" class="req-avatar">
                                <div class="name-col">
                                    <a [routerLink]="['/u', req.username]" class="req-name-link">
                                        <span class="req-name">{{ req.display_name }}</span>
                                    </a>
                                    <span class="req-username">@{{ req.username }}</span>
                                </div>
                            </div>
                            <div class="req-actions">
                                <button class="action-btn join" (click)="acceptFriend(req.friend_id)">Accept</button>
                                <button class="action-btn delete" (click)="rejectFriend(req.friend_id)">Reject</button>
                            </div>
                        </div>
                        }
                    </div>
                </div>

                <div class="inbox-section">
                    <h3>Mission Invitations ({{ socialService.invitations().length }})</h3>
                    <div class="request-list">
                        @for (inv of socialService.invitations(); track inv.invitation_id) {
                        <div class="request-item">
                            <span class="req-name">{{ inv.mission_name }}</span>
                            <div class="req-actions">
                                <button class="action-btn join"
                                    (click)="respondToInvite(inv.invitation_id, true)">Accept</button>
                                <button class="action-btn delete"
                                    (click)="respondToInvite(inv.invitation_id, false)">Reject</button>
                            </div>
                        </div>
                        }
                    </div>
                </div>
            </div>
            }

            <!-- Mission History (Finished) -->
            @if (selectedTabIndex === 4) {
            @if (isLoadingFinishedMissions()) {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading mission history...</p>
            </div>
            } @else if (finishedMissions().length === 0) {
            <div class="empty-state">
                <h3>No finished missions yet</h3>
                <p>Complete or fail missions to see them here!</p>
            </div>
            } @else {
            <div class="table-wrapper">
                <table class="finished-table">
                    <thead>
                        <tr>
                            <th>Room ID</th>
                            <th>Mission</th>
                            <th>Status</th>
                            <th>Crew</th>
                            <th>Leader</th>
                            <th>Date</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (mission of finishedMissions(); track mission.id) {
                        <tr>
                            <td class="code-cell">
                                <span class="room-code">#{{ mission.code }}</span>
                            </td>
                            <td>
                                <div class="mission-cell">
                                    @if (mission.image_url) {
                                    <div class="mission-icon has-image">
                                        <img [src]="mission.image_url" alt="Mission" />
                                    </div>
                                    }
                                    <div class="mission-info">
                                        <span class="name">{{ mission.name }}</span>
                                        <span class="desc">{{ mission.description || 'No description' }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="status" [class]="getStatusClass(mission.status)">
                                    {{ mission.status }}
                                </span>
                            </td>
                            <td>
                                <span class="crew">
                                    Crew: {{ mission.crew_count }}
                                </span>
                            </td>
                            <td class="leader-cell">
                                <span class="leader-name">{{ mission.chief_name }}</span>
                            </td>
                            <td class="date">{{ mission.updated_at | date:'mediumDate' }}</td>
                            <td>
                                <div class="actions">
                                    <button class="action-btn" title="View" (click)="openViewModal(mission)">
                                        View
                                    </button>
                                </div>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
            }
            }
        </div>
    </div>
</div>

<!-- View Modal -->
@if (showViewModal()) {
<div class="modal-overlay" (click)="closeViewModal()">
    <div class="modal modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>Mission Details</h2>
            <button class="close-btn" (click)="closeViewModal()">
                <span>X</span>
            </button>
        </div>
        <div class="modal-body">
            @if (selectedMission(); as mission) {

            <div class="detail-row">
                <span class="label">Room ID</span>
                <span class="value room-code-detail">#{{ mission.code }}</span>
            </div>
            <div class="detail-row">
                <span class="label">Name</span>
                <span class="value">{{ mission.name }}</span>
            </div>
            <div class="detail-row">
                <span class="label">Description</span>
                <span class="value">{{ mission.description || 'No description' }}</span>
            </div>
            <div class="detail-row">
                <span class="label">Status</span>
                <span class="status" [class]="getStatusClass(mission.status)">{{ mission.status }}</span>
            </div>
            <div class="detail-row">
                <span class="label">Created By</span>
                <span class="value creator-name">
                    {{ mission.chief_name }}
                </span>
            </div>
            <div class="detail-row">
                <span class="label">Created</span>
                <span class="value">{{ mission.created_at | date:'medium' }}</span>
            </div>

            <!-- Mission Operations for Chief -->
            @if (isLeader(mission)) {
            <div class="mission-operations-chief">
                @if (mission.status === 'Open' || mission.status === 'Failed') {
                <button class="btn-operation start" (click)="startMission(mission.id)"
                    [disabled]="isProcessing() || mission.crew_count === 0">
                    Start Mission
                </button>
                } @else if (mission.status === 'InProgress') {
                <div class="operation-group">
                    <button class="btn-operation success" (click)="completeMission(mission.id)"
                        [disabled]="isProcessing()">
                        Success
                    </button>
                    <button class="btn-operation fail" (click)="failMission(mission.id)" [disabled]="isProcessing()">
                        Fail
                    </button>
                </div>
                }
            </div>
            }

            <!-- Crew Members Section -->
            <div class="crew-section">
                <div class="crew-header">
                    <span class="label">Crew Members ({{ mission.crew_count }})</span>
                </div>
                @if (loadingCrew()) {
                <div class="crew-loading">
                    <span>Loading crew...</span>
                </div>
                } @else if (crewMembers().length === 0) {
                <div class="crew-empty">
                    <span>No crew members yet</span>
                </div>
                } @else {
                <div class="crew-list">
                    @for (member of crewMembers(); track member.brawler_id) {
                    <div class="crew-member" [class.is-leader]="member.brawler_id === mission.chief_id">
                        <img [src]="member.avatar_url || '/assets/defaultavtar.jpg'" [alt]="member.display_name"
                            class="crew-avatar">
                        <div class="crew-info">
                            <div class="crew-name-row">
                                <a [routerLink]="['/u', member.username]" class="req-name-link">
                                    <span class="crew-name">{{ member.display_name }}</span>
                                </a>
                                @if (member.brawler_id === mission.chief_id) {
                                <span class="leader-badge">
                                    Leader
                                </span>
                                }
                            </div>
                            <span class="crew-stats">
                                {{ member.mission_success_count }} completed · {{ member.mission_joined_count }} joined
                            </span>
                        </div>
                        @if (isLeader(mission) && member.brawler_id !== mission.chief_id)
                        {
                        <button class="kick-btn" (click)="kickMember(member.brawler_id)" title="Kick member"
                            [disabled]="isProcessing()">
                            Kick
                        </button>
                        }
                        @if (member.brawler_id !== passportService.data()?.id && !isFriend(member.brawler_id)) {
                        <button class="action-btn join" (click)="addFriend(member.brawler_id)">Add Friend</button>
                        }
                    </div>
                    }
                </div>
                }
            </div>

            <!-- Invite Friends Section -->
            @if (isInMission(mission.id) || isLeader(mission)) {
            <div class="invite-section">
                <div class="crew-header">
                    <span class="label">Invite Friends</span>
                </div>
                <div class="invite-list">
                    @for (friend of socialService.friends(); track friend.friend_id) {
                    <div class="invite-item">
                        <img [src]="friend.avatar_url || '/assets/defaultavtar.jpg'" class="crew-avatar">
                        <span class="crew-name">{{ friend.display_name }}</span>
                        <button class="action-btn join" (click)="inviteFriend(friend.friend_id)">Invite</button>
                    </div>
                    } @empty {
                    <div class="crew-empty">
                        <span>No friends available to invite.</span>
                    </div>
                    }
                </div>
            </div>
            }

            <!-- Rating Section -->
            @if (isInMission(mission.id)) {
            <div class="rating-section">
                <div class="rating-header">
                    <span class="label">Mission Rating</span>
                    @if (missionRatings()) {
                    <div class="rating-summary">
                        <span class="avg-rating">{{ (missionRatings()!.averageRating || 0).toFixed(1) }}</span>
                        <span class="star-icon">★</span>
                        <span class="total-ratings">({{ missionRatings()!.totalRatings }} ratings)</span>
                    </div>
                    }
                </div>

                <!-- Rate Form -->
                @if (myRating() === null) {
                <div class="rate-form">
                    <div class="star-selector">
                        @for (star of [1,2,3,4,5]; track star) {
                        <button class="star-btn" [class.active]="selectedRating() >= star" (click)="setRating(star)">
                            ★
                        </button>
                        }
                    </div>
                    <textarea class="rating-comment" [ngModel]="ratingComment()"
                        (ngModelChange)="ratingComment.set($event)" placeholder="Add a comment (optional)..."
                        rows="2"></textarea>
                    <button class="submit-rating-btn" [disabled]="selectedRating() === 0 || isSubmittingRating()"
                        (click)="submitRating()">
                        {{ isSubmittingRating() ? 'Submitting...' : 'Submit Rating' }}
                    </button>
                </div>
                } @else {
                <div class="my-rating">
                    <span>Your rating:</span>
                    <div class="stars-display">
                        @for (star of [1,2,3,4,5]; track star) {
                        <span class="star" [class.filled]="myRating()! >= star">★</span>
                        }
                    </div>
                </div>
                }

                <!-- Ratings List -->
                @if (missionRatings() && missionRatings()!.ratings.length > 0) {
                <div class="ratings-list">
                    @for (rating of missionRatings()!.ratings; track rating.id) {
                    <div class="rating-item">
                        <img [src]="rating.brawlerAvatar || '/assets/defaultavtar.jpg'" class="rating-avatar">
                        <div class="rating-content">
                            <div class="rating-top">
                                <span class="rating-author">{{ rating.brawlerName }}</span>
                                <div class="rating-stars">
                                    @for (star of [1,2,3,4,5]; track star) {
                                    <span class="star-small" [class.filled]="rating.rating >= star">★</span>
                                    }
                                </div>
                            </div>
                            @if (rating.comment) {
                            <p class="rating-comment-text">{{ rating.comment }}</p>
                            }
                        </div>
                    </div>
                    }
                </div>
                }
            </div>
            }

            }
        </div>
    </div>
</div>
}

<!-- Edit Modal -->
@if (showEditModal()) {
<div class="modal-overlay" (click)="closeEditModal()">
    <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>Edit Mission</h2>
            <button class="close-btn" (click)="closeEditModal()">
                <span>X</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="edit-name">Mission Name</label>
                <input type="text" id="edit-name" [(ngModel)]="editName" placeholder="Enter mission name" />
            </div>
            <div class="form-group">
                <label for="edit-desc">Description</label>
                <textarea id="edit-desc" [(ngModel)]="editDescription" placeholder="Enter description"
                    rows="4"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" (click)="closeEditModal()">Cancel</button>
            <button class="btn-primary" (click)="submitEdit()" [disabled]="isProcessing()">
                {{ isProcessing() ? 'Saving...' : 'Save Changes' }}
            </button>
        </div>
    </div>
</div>
}

<!-- Delete Modal -->
@if (showDeleteModal()) {
<div class="modal-overlay" (click)="closeDeleteModal()">
    <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>Delete Mission</h2>
            <button class="close-btn" (click)="closeDeleteModal()">
                <span>X</span>
            </button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete mission "{{ selectedMission()?.name }}"?</p>
            <p class="warning-text">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" (click)="closeDeleteModal()">Cancel</button>
            <button class="btn-danger" (click)="confirmDelete()" [disabled]="isProcessing()">
                {{ isProcessing() ? 'Deleting...' : 'Delete Mission' }}
            </button>
        </div>
    </div>
</div>
}